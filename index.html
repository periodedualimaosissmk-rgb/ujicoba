<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Laporan | Admin OSIS & Guru</title>
    <link rel="icon" type="image/gif" href="https://cdn.yupra.my.id/yp/dc9y33vh.jpg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), 
                        url('https://cdn.yupra.my.id/yp/fb90uw64.jpg') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            display: flex; justify-content: center; align-items: center; padding: 20px;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 30px;
            width: 100%;
            color: white;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        h2 { text-align: center; color: #25D366; margin-bottom: 20px; text-transform: uppercase; }

        input, select {
            width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1);
            color: white; outline: none;
        }

        button {
            width: 100%; padding: 12px; border: none; border-radius: 12px;
            font-weight: 600; cursor: pointer; transition: 0.3s; margin-bottom: 10px;
        }

        .btn-send { background: linear-gradient(135deg, #25D366, #128C7E); color: white; }
        .btn-download { background: #3498db; color: white; margin-bottom: 20px; }
        .btn-logout { background: rgba(255, 71, 87, 0.2); color: #ff4757; border: 1px solid #ff4757; }

        .table-container { width: 100%; overflow-x: auto; border-radius: 15px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: rgba(255, 255, 255, 0.1); padding: 12px; color: #25D366; text-align: left; font-size: 13px; }
        td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 12px; }

        .date-bold { font-weight: bold; display: block; }
        .hour-dim { color: #aaa; font-size: 0.8em; }
        #filter-info { text-align: center; margin-bottom: 15px; color: #25D366; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-section" class="glass-effect" style="max-width: 400px;">
        <h2>Portal Monitoring</h2>
        <form id="form-login">
            <input type="text" id="user" placeholder="Username" required>
            <input type="password" id="pass" placeholder="Password" required>
            <button type="submit" class="btn-send">Masuk Dashboard</button>
        </form>
    </div>

    <div id="data-section" class="glass-effect" style="display: none; max-width: 1100px;">
        <h2>Dashboard Laporan</h2>
        <p id="filter-info">Memuat data...</p>

        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <select id="filter-tanggal" style="flex: 1; min-width: 200px;"></select>
            <button id="download-csv" class="btn-download" style="flex: 0.5; min-width: 150px;">ðŸ’¾ Unduh Data (.csv)</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                <tr id="table-head"></tr>
                </thead>
                <tbody id="tabel-body"></tbody>
            </table>
        </div>
        
        <button onclick="location.reload()" class="btn-logout" style="margin-top: 20px;">Keluar Sistem</button>
    </div>
  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/165QaH8Lg2P8TXn30V4Xm95QNUfgZqMirty9B5GetGv8/export?format=csv";
    let allDataRows = [];
    let currentAuth = { user: "", role: "", kelas: "", jurusan: "" };

    const akunDb = {
        "walas 10 tkr": "10 tkr", 
        "walas 10 mp": "10 mp", 
        "walas 10 tkj": "10 tkj",
        "walas 11 tkr": "11 tkr", 
        "walas 11 mp": "11 mp", 
        "walas 11 tkj" : "11 tkj",
        "walas 12 tkr": "12 tkr", 
        "walas 12 mp": "12 mp", 
        "walas 12 tkj": "12 tkj",
        "guru bk": "guru bk", 
        "osis th": "osis tunas"
    };

    function parseDT(str) {
        if (!str) return { t: "N/A", j: "" };
        str = str.replace(/"/g, '').trim();
        let p = str.split(' '), t = "N/A", j = "";
        p.forEach(x => { 
            if(x.includes('/') || x.includes('-')) t = x; 
            else if(x.includes(':')) j = x; 
        });
        return { t, j };
    }

    document.getElementById('form-login').addEventListener('submit', async (e) => {
        e.preventDefault();
        const u = document.getElementById('user').value.toLowerCase().trim();
        const p = document.getElementById('pass').value.toLowerCase().trim();

        if (akunDb[u] === p) {
            currentAuth.user = u;
            currentAuth.role = (u === "guru bk" || u === "osis th") ? "ADMIN" : "WALAS";
            
            if (currentAuth.role === "WALAS") {
                let parts = p.split(' ');
                currentAuth.kelas = parts[0];
                currentAuth.jurusan = parts.slice(1).join(' ').toUpperCase();
            }
            
            await loadData();
        } else { 
            alert("âŒ Login Gagal! Periksa kembali Username & Password."); 
        }
    });

    async function loadData() {
        try {
            // Cache buster untuk memastikan data selalu fresh dari Google Sheets
            const res = await fetch(csvUrl + "&cache_buster=" + new Date().getTime());
            const text = await res.text();
            allDataRows = text.split(/\r?\n/).filter(l => l.trim() !== "").slice(1).reverse();
            
            initUI();
            renderTable("Semua");
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('data-section').style.display = 'block';
        } catch (err) {
            alert("Gagal memuat data. Periksa koneksi internet Anda.");
        }
    }

    function initUI() {
        const drop = document.getElementById('filter-tanggal');
        const dates = new Set();
        allDataRows.forEach(r => {
            const cols = r.split(/[,;]/);
            if(cols[0]) dates.add(parseDT(cols[0]).t);
        });
        
        drop.innerHTML = '<option value="Semua">-- Semua Tanggal --</option>';
        dates.forEach(d => {
            if(d !== "N/A") drop.innerHTML += `<option value="${d}">${d}</option>`;
        });

        // Setup Header Tabel Berdasarkan Role
        const head = document.getElementById('table-head');
        let columns = `<th>WAKTU</th><th>NAMA SISWA</th>`;
        if (currentAuth.role === "ADMIN") columns += `<th>KELAS</th><th>JURUSAN</th>`;
        columns += `<th>PELANGGARAN</th><th>PETUGAS</th>`;
        head.innerHTML = columns;
    }

    function renderTable(fTgl) {
        const tbody = document.getElementById('tabel-body');
        tbody.innerHTML = '';
        let count = 0;

        allDataRows.forEach(row => {
            let c = row.match(/(".*?"|[^",;]+)(?=[,;]|$)/g) || [];
            if (c.length < 5) return;

            const { t, j } = parseDT(c[0]);
            const rKel = c[2].replace(/"/g, '').trim();
            const rJur = c[3].replace(/"/g, '').trim().toUpperCase();

            const isAuth = (currentAuth.role === "ADMIN") || (rKel === currentAuth.kelas && rJur === currentAuth.jurusan);
            const isDate = (fTgl === "Semua" || t === fTgl);

            if (isAuth && isDate) {
                let rowHtml = `<tr>
                    <td><span class="date-bold">${t}</span><span class="hour-dim">${j}</span></td>
                    <td style="font-weight:600">${c[1].replace(/"/g, '')}</td>`;
                
                if (currentAuth.role === "ADMIN") {
                    rowHtml += `<td>${rKel}</td><td>${rJur}</td>`;
                }

                rowHtml += `<td style="color:#ff9f43; font-style:italic;">${c[4].replace(/"/g, '')}</td>
                            <td>${(c[5]||"-").replace(/"/g, '')}</td></tr>`;
                
                tbody.insertAdjacentHTML('beforeend', rowHtml);
                count++;
            }
        });
        
        let label = (currentAuth.role === "ADMIN") ? "Semua Kelas" : `${currentAuth.kelas} ${currentAuth.jurusan}`;
        document.getElementById('filter-info').innerText = `Ditemukan ${count} Laporan (${label})`;
    }

    // FITUR UNDUH DENGAN NAMA FILE SESUAI REQUEST
    document.getElementById('download-csv').addEventListener('click', () => {
        let csvContent = "\uFEFF"; 
        const rows = document.querySelectorAll("table tr");
        
        rows.forEach(row => {
            const cols = row.querySelectorAll("td, th");
            const rowData = Array.from(cols).map(c => `"${c.innerText.replace(/\n/g, ' ')}"`).join(",");
            csvContent += rowData + "\r\n";
        });

        // Ambil Tanggal untuk Nama File
        const d = new Date();
        const tglHariIni = `${d.getDate()}-${d.getMonth() + 1}-${d.getFullYear()}`;
        const filterVal = document.getElementById('filter-tanggal').value;
        const tglFile = (filterVal === "Semua") ? tglHariIni : filterVal.replace(/\//g, '-');

        let fileName = "";
        if (currentAuth.role === "ADMIN") {
            // Guru BK / OSIS
            fileName = `Laporan Piket ${tglFile}.csv`;
        } else {
            // Wali Kelas
            fileName = `Laporan ${currentAuth.kelas} ${currentAuth.jurusan} ${tglFile}.csv`;
        }

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
    });

    document.getElementById('filter-tanggal').addEventListener('change', (e) => renderTable(e.target.value));
  </script>

    

</body>
</html>
